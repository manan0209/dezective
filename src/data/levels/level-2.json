{
  "id": "level-2",
  "title": "Database Breach Investigation",
  "difficulty": "Intermediate", 
  "description": "A database containing customer information has been compromised. Investigate the breach and determine the extent of the data exposure.",
  "scenario": {
    "briefing": "Critical alert: Our customer database server has been breached. Automated systems detected unauthorized data extraction at 2:15 AM. The security team needs you to investigate the scope of the breach and identify the attack vector.",
    "objective": "Determine what data was accessed and how the attacker gained entry.",
    "timeLimit": 2400,
    "maxHints": 4
  },
  "environment": {
    "serverName": "db-server-02",
    "osType": "Linux",
    "availableCommands": [
      "ls", "cat", "grep", "find", "head", "tail", "less", "pwd", "cd", "history", "whoami", "ps", "netstat", "last", "awk", "sort", "uniq", "wc"
    ],
    "fileSystem": {
      "/var/log/mysql/error.log": {
        "type": "file",
        "content": [
          "2024-01-16 02:10:45 [Warning] Access denied for user 'admin'@'192.168.1.50' (using password: YES)",
          "2024-01-16 02:12:33 [Warning] Access denied for user 'root'@'192.168.1.50' (using password: YES)", 
          "2024-01-16 02:14:21 [Note] Connection established from 192.168.1.50 user: backup_user",
          "2024-01-16 02:15:12 [Warning] Large result set detected: 45000 rows returned in single query",
          "2024-01-16 02:16:45 [Note] Connection closed for user backup_user@192.168.1.50"
        ]
      },
      "/var/log/mysql/query.log": {
        "type": "file",
        "content": [
          "2024-01-16 02:15:12 Connect backup_user@192.168.1.50 on customers_db",
          "2024-01-16 02:15:15 Query SELECT * FROM users WHERE created_date > '2023-01-01'",
          "2024-01-16 02:15:45 Query SELECT customer_id, name, email, phone, ssn FROM customer_data",
          "2024-01-16 02:16:12 Query SELECT * FROM payment_info WHERE status = 'active'",
          "2024-01-16 02:16:30 Quit"
        ]
      },
      "/var/log/apache2/access.log": {
        "type": "file", 
        "content": [
          "192.168.1.50 - - [16/Jan/2024:02:08:33 +0000] \"POST /admin/login.php HTTP/1.1\" 401 1234",
          "192.168.1.50 - - [16/Jan/2024:02:09:15 +0000] \"POST /admin/login.php HTTP/1.1\" 401 1234",
          "192.168.1.50 - - [16/Jan/2024:02:11:42 +0000] \"GET /backup/database_export.php HTTP/1.1\" 200 5678",
          "192.168.1.50 - - [16/Jan/2024:02:13:25 +0000] \"POST /backup/database_export.php HTTP/1.1\" 200 45000000"
        ]
      },
      "/var/www/backup/database_export.php": {
        "type": "file",
        "content": [
          "<?php",
          "// Database backup utility - INTERNAL USE ONLY",
          "// Default credentials for emergency access",
          "$username = 'backup_user';", 
          "$password = 'backup123!';",
          "",
          "if ($_POST['action'] == 'export') {",
          "    $mysqli = new mysqli('localhost', $username, $password, 'customers_db');",
          "    $result = $mysqli->query($_POST['query']);", 
          "    // Export data...",
          "}"
        ]
      },
      "/home/backup_user/.mysql_history": {
        "type": "file",
        "content": [
          "USE customers_db;",
          "SHOW TABLES;",
          "SELECT COUNT(*) FROM customer_data;",
          "SELECT * FROM users WHERE created_date > '2023-01-01' INTO OUTFILE '/tmp/users_export.csv';",
          "SELECT customer_id, name, email, phone, ssn FROM customer_data INTO OUTFILE '/tmp/customers_export.csv';",
          "SELECT * FROM payment_info WHERE status = 'active' INTO OUTFILE '/tmp/payments_export.csv';"
        ]
      },
      "/tmp/breach_summary.txt": {
        "type": "file",
        "content": [
          "DATA BREACH SUMMARY",
          "===================",
          "Target: Customer Database",
          "Access Method: Web backup utility with default credentials",
          "Compromised Tables:",
          "- users: 12,450 records (personal info)",
          "- customer_data: 8,230 records (PII including SSN)", 
          "- payment_info: 5,670 records (payment methods)",
          "",
          "Total Records Exposed: 26,350",
          "Data Exported To: /tmp/*.csv files",
          "Attack Duration: ~8 minutes"
        ]
      }
    }
  },
  "clues": [
    {
      "id": "clue-1",
      "title": "Failed Authentication Attempts",
      "description": "Multiple failed login attempts preceded the successful breach.",
      "hint": "Check the database error logs for authentication failures",
      "triggerCommands": ["cat /var/log/mysql/error.log", "grep -i 'access denied' /var/log/mysql/error.log"],
      "revealed": false
    },
    {
      "id": "clue-2",
      "title": "Web Application Access",
      "description": "The attacker used a web interface to access the database.",
      "hint": "Look at the web server access logs around the time of the breach",
      "triggerCommands": ["cat /var/log/apache2/access.log", "grep '192.168.1.50' /var/log/apache2/access.log"],
      "revealed": false
    },
    {
      "id": "clue-3",
      "title": "Database Queries",
      "description": "Large amounts of sensitive data were extracted via SQL queries.",
      "hint": "Check the MySQL query log to see what data was accessed",
      "triggerCommands": ["cat /var/log/mysql/query.log"],
      "revealed": false
    },
    {
      "id": "clue-4",
      "title": "Backup Script Vulnerability", 
      "description": "A backup utility with default credentials was exploited.",
      "hint": "Examine the backup script to understand the attack vector",
      "triggerCommands": ["cat /var/www/backup/database_export.php"],
      "revealed": false
    }
  ],
  "solution": {
    "steps": [
      "Identify failed login attempts in MySQL error log from IP 192.168.1.50",
      "Discover successful connection using backup_user credentials", 
      "Find web access logs showing requests to backup utility",
      "Examine database queries that extracted sensitive customer data",
      "Locate the vulnerable backup script with hardcoded credentials",
      "Find evidence of data export in MySQL history and summary file"
    ],
    "finalAnswer": "/tmp/breach_summary.txt",
    "explanation": "The attacker discovered a backup utility at /backup/database_export.php with hardcoded credentials. They used this to extract 26,350 customer records including PII and payment information over an 8-minute period."
  },
  "scoring": {
    "maxScore": 1500,
    "timeBonus": 400,
    "hintPenalty": 125,
    "wrongCommandPenalty": 75
  }
}
